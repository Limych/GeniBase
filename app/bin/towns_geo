#!/usr/bin/env php
<?php
        
define('BASE_DIR', dirname(__DIR__));

$fpath = BASE_DIR . '/app/src/assets/towns_1913.txt';
$fpath_tmp = $fpath . '.tmp';

$towns = preg_split("/[\r\n]+/", file_get_contents($fpath), null, PREG_SPLIT_NO_EMPTY);
@file_put_contents($fpath_tmp, '');

$mod = false;
foreach ($towns as $town) {
    if (preg_match("/^(.* >\s+([\w\s]+) \[)\,\]$/u", $town, $matches)
    && (false !== $coord = getCoord($matches[2]))) {
        @file_put_contents($fpath_tmp, $matches[1] . $coord . "]\n", FILE_APPEND);
        $mod = true;
    } else {
        @file_put_contents($fpath_tmp, "$town\n", FILE_APPEND);
    }
}

if ($mod) {
    @unlink($fpath);
    @rename($fpath_tmp, $fpath);
}

function getCoord($town) {
    $url = 'https://ru.wikipedia.org/wiki/' . urlencode($town);
    $content = @file_get_contents($url);
    
    if (false !== $content && preg_match("|//maps\.google\.com/maps\?ll=([^&]+)|", $content, $matches)) {
        return $matches[1];
    }
    return false;
}
