#!/usr/bin/env php
<?php
/**
 * GeniBase â€” the content management system for genealogical websites.
 *
 * @package GeniBase
 * @author Andrey Khrolenok <andrey@khrolenok.ru>
 * @copyright Copyright (C) 2014-2017 Andrey Khrolenok
 * @license GNU Affero General Public License v3 <http://www.gnu.org/licenses/agpl-3.0.txt>
 * @link https://github.com/Limych/GeniBase
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, version 3.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/agpl-3.0.txt.
 */
        
define('BASE_DIR', dirname(__DIR__));

$fpath = BASE_DIR . '/app/src/assets/towns_1913.txt';
$fpath_tmp = $fpath . '.tmp';

$towns = preg_split("/[\r\n]+/", file_get_contents($fpath), null, PREG_SPLIT_NO_EMPTY);
@file_put_contents($fpath_tmp, '');

$mod = false;
foreach ($towns as $town) {
    if (preg_match("/^(.* >\s+([\w\s]+) \[)\,\]$/u", $town, $matches)
    && (false !== $coord = getCoord($matches[2]))) {
        @file_put_contents($fpath_tmp, $matches[1] . $coord . "]\n", FILE_APPEND);
        $mod = true;
    } else {
        @file_put_contents($fpath_tmp, "$town\n", FILE_APPEND);
    }
}

if ($mod) {
    @unlink($fpath);
    @rename($fpath_tmp, $fpath);
}

function getCoord($town) {
    $url = 'https://ru.wikipedia.org/wiki/' . urlencode($town);
    $content = @file_get_contents($url);
    
    if (false !== $content && preg_match("|//maps\.google\.com/maps\?ll=([^&]+)|", $content, $matches)) {
        return $matches[1];
    }
    return false;
}
